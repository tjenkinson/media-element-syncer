{"version":3,"sources":["media-element-syncer.js"],"names":["EVENTS","MediaElementSyncer","source","refreshInterval","correctionTime","seekThreshold","_source","_children","_updateTimer","_refreshInterval","_correctionTime","_seekThreshold","_config","Map","collecting","_eventHandler","window","setTimeout","_update","element","offset","indexOf","length","_addEventListeners","set","push","index","delete","_removeEventListeners","splice","clearTimeout","sourceTime","currentTime","sourcePlaybackRate","playbackRate","forEach","child","config","get","targetTime","sourcePaused","paused","ended","duration","diff","rate","Math","max","pause","play","abs","e","eventName","addEventListener","removeEventListener"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,MAAM,GAAG,CAAC,MAAD,EAAS,OAAT,EAAkB,SAAlB,EAA6B,QAA7B,EAAuC,SAAvC,EAAkD,SAAlD,CAAf;;IAEaC;;;AACX,8BACEC,MADF,EAGE;AAAA;;AAAA,mFADwE,EACxE;AAAA,oCADEC,eACF;AAAA,QADEA,eACF,qCADoB,GACpB;AAAA,mCADyBC,cACzB;AAAA,QADyBA,cACzB,oCAD0C,GAC1C;AAAA,kCAD+CC,aAC/C;AAAA,QAD+CA,aAC/C,mCAD+D,IAC/D;;AAAA;;AACA,SAAKC,OAAL,GAAeJ,MAAf;AACA,SAAKK,SAAL,GAAiB,EAAjB;AACA,SAAKC,YAAL,GAAoB,IAApB;AACA,SAAKC,gBAAL,GAAwBN,eAAxB;AACA,SAAKO,eAAL,GAAuBN,cAAc,GAAG,IAAxC;AACA,SAAKO,cAAL,GAAsBN,aAAa,GAAG,IAAtC;AACA,SAAKO,OAAL,GAAe,IAAIC,GAAJ,EAAf;AACA,QAAIC,UAAU,GAAG,KAAjB;;AACA,SAAKC,aAAL,GAAqB,YAAM;AACzB,UAAID,UAAJ,EAAgB;AACd;AACD;;AACDA,MAAAA,UAAU,GAAG,IAAb;AACAE,MAAAA,MAAM,CAACC,UAAP,CAAkB,YAAM;AACtBH,QAAAA,UAAU,GAAG,KAAb;;AACA,QAAA,KAAI,CAACI,OAAL;AACD,OAHD,EAGG,CAHH;AAID,KATD;AAUD;;;;6BAEQC,SAA8B;AAAA,sFAAJ,EAAI;AAAA,+BAAnBC,MAAmB;AAAA,UAAnBA,MAAmB,6BAAV,CAAU;;AACrC,UAAI,KAAKb,SAAL,CAAec,OAAf,CAAuBF,OAAvB,MAAoC,CAAC,CAAzC,EAA4C;AAC1C,YAAI,CAAC,KAAKZ,SAAL,CAAee,MAApB,EAA4B;AAC1B,eAAKC,kBAAL,CAAwB,KAAKjB,OAA7B;AACD;;AACD,aAAKM,OAAL,CAAaY,GAAb,CAAiBL,OAAjB,EAA0B;AAAEC,UAAAA,MAAM,EAANA;AAAF,SAA1B;;AACA,aAAKb,SAAL,CAAekB,IAAf,CAAoBN,OAApB;;AACA,aAAKI,kBAAL,CAAwBJ,OAAxB;;AACA,aAAKD,OAAL;AACD;AACF;;;gCAEWC,SAAS;AACnB,UAAMO,KAAK,GAAG,KAAKnB,SAAL,CAAec,OAAf,CAAuBF,OAAvB,CAAd;;AACA,UAAIO,KAAK,IAAI,CAAb,EAAgB;AACd,aAAKd,OAAL,CAAae,MAAb,CAAoBR,OAApB;;AACA,aAAKS,qBAAL,CAA2BT,OAA3B;;AACA,aAAKZ,SAAL,CAAesB,MAAf,CAAsBH,KAAtB,EAA6B,CAA7B;;AACA,YAAI,CAAC,KAAKnB,SAAL,CAAee,MAApB,EAA4B;AAC1B,cAAI,KAAKd,YAAT,EAAuB;AACrBQ,YAAAA,MAAM,CAACc,YAAP,CAAoB,KAAKtB,YAAzB;AACA,iBAAKA,YAAL,GAAoB,IAApB;AACD;;AACD,eAAKoB,qBAAL,CAA2B,KAAKtB,OAAhC;AACD;AACF;AACF;;;8BAES;AAAA;;AACR,UAAI,KAAKE,YAAT,EAAuB;AACrBQ,QAAAA,MAAM,CAACc,YAAP,CAAoB,KAAKtB,YAAzB;AACD;;AAED,UAAI,CAAC,KAAKD,SAAL,CAAee,MAApB,EAA4B;AAC1B;AACD;;AAED,UAAMS,UAAU,GAAG,KAAKzB,OAAL,CAAa0B,WAAhC;AACA,UAAMC,kBAAkB,GAAG,KAAK3B,OAAL,CAAa4B,YAAxC;;AACA,WAAK3B,SAAL,CAAe4B,OAAf,CAAuB,UAAAC,KAAK,EAAI;AAC9B,YAAI;AACF,cAAMC,MAAM,GAAG,MAAI,CAACzB,OAAL,CAAa0B,GAAb,CAAiBF,KAAjB,CAAf;;AACA,cAAMG,UAAU,GAAGR,UAAU,GAAGM,MAAM,CAACjB,MAAP,GAAgB,IAAhD;AACA,cAAMoB,YAAY,GAChB,MAAI,CAAClC,OAAL,CAAamC,MAAb,IACA,MAAI,CAACnC,OAAL,CAAaoC,KADb,IAEAH,UAAU,GAAG,CAFb,IAGAA,UAAU,IAAIH,KAAK,CAACO,QAJtB;AAKA,cAAMX,WAAW,GAAGI,KAAK,CAACJ,WAA1B;AACA,cAAMY,IAAI,GAAGL,UAAU,GAAGP,WAA1B;AACA,cAAMa,IAAI,GAAGC,IAAI,CAACC,GAAL,CACX,CADW,EAEV,CAACH,IAAI,GAAG,MAAI,CAAClC,eAAb,IAAgC,MAAI,CAACA,eAAtC,GACEuB,kBAHS,CAAb;;AAKA,cAAIO,YAAY,KAAKJ,KAAK,CAACK,MAA3B,EAAmC;AACjCD,YAAAA,YAAY,GAAGJ,KAAK,CAACY,KAAN,EAAH,GAAmBZ,KAAK,CAACa,IAAN,EAA/B;AACD;;AACD,cAAIT,YAAY,IAAIK,IAAI,GAAG,CAAvB,IAA4BC,IAAI,CAACI,GAAL,CAASN,IAAT,KAAkB,MAAI,CAACjC,cAAvD,EAAuE;AACrEyB,YAAAA,KAAK,CAACJ,WAAN,GAAoBO,UAApB;AACAH,YAAAA,KAAK,CAACF,YAAN,GAAqBD,kBAArB;AACD,WAHD,MAGO;AACLG,YAAAA,KAAK,CAACF,YAAN,GAAqBW,IAArB;AACD;AACF,SAxBD,CAwBE,OAAOM,CAAP,EAAU;AACVnC,UAAAA,MAAM,CAACC,UAAP,CAAkB,YAAM;AACtB,kBAAMkC,CAAN;AACD,WAFD,EAEG,CAFH;AAGD;AACF,OA9BD;;AAgCA,WAAK3C,YAAL,GAAoBQ,MAAM,CAACC,UAAP,CAClB;AAAA,eAAM,MAAI,CAACC,OAAL,EAAN;AAAA,OADkB,EAElB,KAAKT,gBAFa,CAApB;AAID;;;uCAEkBU,SAAS;AAAA;;AAC1BnB,MAAAA,MAAM,CAACmC,OAAP,CAAe,UAAAiB,SAAS;AAAA,eACtBjC,OAAO,CAACkC,gBAAR,CAAyBD,SAAzB,EAAoC,MAAI,CAACrC,aAAzC,CADsB;AAAA,OAAxB;AAGD;;;0CAEqBI,SAAS;AAAA;;AAC7BnB,MAAAA,MAAM,CAACmC,OAAP,CAAe,UAAAiB,SAAS;AAAA,eACtBjC,OAAO,CAACmC,mBAAR,CAA4BF,SAA5B,EAAuC,MAAI,CAACrC,aAA5C,CADsB;AAAA,OAAxB;AAGD","file":"media-element-syncer.js","sourceRoot":"../src","sourcesContent":["const EVENTS = ['play', 'pause', 'seeking', 'seeked', 'playing', 'stalled'];\n\nexport class MediaElementSyncer {\n  constructor(\n    source,\n    { refreshInterval = 200, correctionTime = 500, seekThreshold = 1000 } = {}\n  ) {\n    this._source = source;\n    this._children = [];\n    this._updateTimer = null;\n    this._refreshInterval = refreshInterval;\n    this._correctionTime = correctionTime / 1000;\n    this._seekThreshold = seekThreshold / 1000;\n    this._config = new Map();\n    let collecting = false;\n    this._eventHandler = () => {\n      if (collecting) {\n        return;\n      }\n      collecting = true;\n      window.setTimeout(() => {\n        collecting = false;\n        this._update();\n      }, 0);\n    };\n  }\n\n  addChild(element, { offset = 0 } = {}) {\n    if (this._children.indexOf(element) === -1) {\n      if (!this._children.length) {\n        this._addEventListeners(this._source);\n      }\n      this._config.set(element, { offset });\n      this._children.push(element);\n      this._addEventListeners(element);\n      this._update();\n    }\n  }\n\n  removeChild(element) {\n    const index = this._children.indexOf(element);\n    if (index >= 0) {\n      this._config.delete(element);\n      this._removeEventListeners(element);\n      this._children.splice(index, 1);\n      if (!this._children.length) {\n        if (this._updateTimer) {\n          window.clearTimeout(this._updateTimer);\n          this._updateTimer = null;\n        }\n        this._removeEventListeners(this._source);\n      }\n    }\n  }\n\n  _update() {\n    if (this._updateTimer) {\n      window.clearTimeout(this._updateTimer);\n    }\n\n    if (!this._children.length) {\n      return;\n    }\n\n    const sourceTime = this._source.currentTime;\n    const sourcePlaybackRate = this._source.playbackRate;\n    this._children.forEach(child => {\n      try {\n        const config = this._config.get(child);\n        const targetTime = sourceTime + config.offset / 1000;\n        const sourcePaused =\n          this._source.paused ||\n          this._source.ended ||\n          targetTime < 0 ||\n          targetTime >= child.duration;\n        const currentTime = child.currentTime;\n        const diff = targetTime - currentTime;\n        const rate = Math.max(\n          0,\n          ((diff + this._correctionTime) / this._correctionTime) *\n            sourcePlaybackRate\n        );\n        if (sourcePaused !== child.paused) {\n          sourcePaused ? child.pause() : child.play();\n        }\n        if (sourcePaused || rate < 0 || Math.abs(diff) >= this._seekThreshold) {\n          child.currentTime = targetTime;\n          child.playbackRate = sourcePlaybackRate;\n        } else {\n          child.playbackRate = rate;\n        }\n      } catch (e) {\n        window.setTimeout(() => {\n          throw e;\n        }, 0);\n      }\n    });\n\n    this._updateTimer = window.setTimeout(\n      () => this._update(),\n      this._refreshInterval\n    );\n  }\n\n  _addEventListeners(element) {\n    EVENTS.forEach(eventName =>\n      element.addEventListener(eventName, this._eventHandler)\n    );\n  }\n\n  _removeEventListeners(element) {\n    EVENTS.forEach(eventName =>\n      element.removeEventListener(eventName, this._eventHandler)\n    );\n  }\n}\n"]}